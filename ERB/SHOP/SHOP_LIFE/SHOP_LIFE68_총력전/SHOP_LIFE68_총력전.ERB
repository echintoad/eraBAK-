;-------------------------------------------------
;「총력전」의 명칭
;-------------------------------------------------
@SHOP_LIFE_NAME68
RESULTS '= "총력전"

;-------------------------------------------------
;「총력전」의 선택 가부 판정
;-------------------------------------------------
@SHOP_LIFE_CHECK68
SIF CFLAG:MASTER:포로처 || 총력전클리어플래그 == 1
	RETURN 0
RETURN 1

;-------------------------------------------------
;「총력전」의 선택 가능 캐릭터 존재 판정
;-------------------------------------------------
@SHOP_LIFE_CHECKCHARA68(ARG:0)
;비주인공, 동일 세력, 포로가 아닌, 동물이 아닌, 통상 상태 또는 육아중
SIF CFLAG:(ARG:0):특수상태 == 특수상태_방랑
	RETURN TALENT:(ARG:0):연모 || TALENT:(ARG:0):복종
SIF CFLAG:(ARG:0):특수상태 == 특수상태_미등장 || CFLAG:(ARG:0):특수상태 == 특수상태_사망
	RETURN 0
RETURN CFLAG:(ARG:0):소속 == CFLAG:MASTER:소속 && CFLAG:(ARG:0):포로처 == 0 && !IS_ANIMAL(ARG:0) && GROUPMATCH(CFLAG:(ARG:0):행동불능상태, 0, 2) || TALENT:ARG:연모 || TALENT:ARG:복종

;-------------------------------------------------
;「총력전」의 왼쪽 컬럼 메뉴의 입력 처리
;-------------------------------------------------
@SHOP_LIFE_EVENTBUY68
FLAG:거점페이즈페이지 = 1
FLAG:요바이 = 0
RETURN 0

;-------------------------------------------------
;「침실호출」의 오른쪽 컬럼 캐릭터 리스트 1의 버튼（함수미지정이라면 선택중색없음 표시）
;-------------------------------------------------
@SHOP_LIFE_LIST1_BUTTON68(ARG:0, ARG:1)
;캐릭터, 선택중 칼라 표시 플래그, 버튼 번호에 추가하는 수치, CHECKCHARA의 반환값, 행동이 끝난 마크를 오프로 하는 플래그
CALL COLUMN_RIGHT_CHARALIST_BUTTON(ARG:0, CFLAG:(ARG:0):총력전선택중, SHOP_LIFE_LIST1_ADD_INPUT, ARG:1)
RETURN 0

;-------------------------------------------------
;「데이트」의 오른쪽 컬럼 표시 처리
;-------------------------------------------------
@SHOP_LIFE_EVENTBUY_SHOW68
#DIM 선택인원수

선택인원수 = 0

FOR LOCAL:0, 0, CHARANUM
	;선택 가능한지 판정
	RESULT = 0
	TRYCALLFORM SHOP_LIFE_CHECKCHARA{FLAG:거점페이즈선택커맨드}(LOCAL:0)
	IF RESULT == 1
		;선택중의 인원수를 센다
		IF CFLAG:(LOCAL:0):총력전선택중
			선택인원수 ++
		ENDIF
	ELSE
		;조건을 채우지 않으면 강제적으로ＯＦＦ
		CFLAG:(LOCAL:0):총력전선택중 = 0
	ENDIF
NEXT

CALL COLUMN_RIGHT_TITLE("대상자 선택", TOSTR(선택인원수), "5", "0", "0", "자세력또는 함락 상대만 가능")
CALL COLUMN_RIGHT_PRINTL
CALL COLUMN_RIGHT_LINE
CALL COLUMN_RIGHT_PRINTL
;오른쪽 컬럼의 표준적인 캐릭터 리스트와 페이지 이동 호출
IF 선택인원수 >= 1
	PRINTBUTTON "[이 멤버로 결정]", 1
	PRINTPLAIN   
	PRINTBUTTON "[리셋]", 2
ELSE
	SETCOLOR 칼라_선택불가
	PRINTPLAINFORM [이 멤버로 결정]
	PRINTPLAIN   
	PRINTPLAINFORM [리셋트]
	RESETCOLOR
ENDIF
CALL COLUMN_RIGHT_PRINTL
CALL COLUMN_RIGHT_LINE
CALL COLUMN_RIGHT_PRINTL

CALL COLUMN_RIGHT_CHARALIST
RETURN

@SHOP_LIFE_EVENTBUY_SUB68(ARG)
;이 멤버로 결정
IF ARG == 1
	CALL 대상설정
	IF !RESULT
		RETURN 0
	ENDIF
;멤버를 리셋트
ELSEIF ARG == 2
	CALL 총력전_멤버_리셋
ENDIF
RETURN 0
;-------------------------------------------------
;「총력전」의 리스트 1 입력 처리
;-------------------------------------------------
@SHOP_LIFE_USERSHOP68(ARG:0)
;참가 캐릭터의 수를 센다
LOCAL:5 = 0
FOR LOCAL:0, 0, CHARANUM
	IF CFLAG:(LOCAL:0):총력전선택중
		LOCAL:5 ++
	ENDIF
NEXT
IF CFLAG:(ARG:0):총력전선택중 || LOCAL:5 < 5
	CFLAG:(ARG:0):총력전선택중 = !CFLAG:(ARG:0):총력전선택중
ENDIF
RETURN 0
;-------------------------------------------------
;「총력전」 보스 설정
;-------------------------------------------------
@대상설정
#DIM FIRST_LINE
#DIM 보스

#DIM 보스수
#DIM 페이지
#DIM iTmp

CALL 총력전_해제

FIRST_LINE = LINECOUNT

; 보스 리스트 설정
; 임시
VARSET 총력전_보스_활동, -1
총력전_보스_활동:0 = 0

; 보스 활동 에서 찾기
FOR iTmp, 0, 20
	IF 총력전_보스_활동:iTmp == -1
		BREAK
	ENDIF
	; 임시로 총력전 창에 추가
	; UI 프레임에 나오고 버튼 활성화
	총력전_상태:iTmp = 1
	총력전_ID:iTmp = 총력전_보스_활동:iTmp
	CALLFORM 총력전_보스_이름_{총력전_보스_활동:iTmp}
	총력전_이름:iTmp = %RESULTS%
	CALLFORM 총력전_보스_이미지_{총력전_보스_활동:iTmp}
	총력전_이미지:iTmp = %RESULTS%
NEXT

; 보스가 있는지 확인, 없으면 메세지(키보토스는 평?화로운 상태)
; 아님 총력전 클리어 플레그?

; 디버그용 TEST CODE
; 총력전_상태:1 = 1
; 총력전_ID:1 = 0
; 총력전_이름:1 = 몰?루
; 총력전_이미지:1 = 얼굴_의복_통상_22

; inputloop
$INPUTLOOP
CALL SINGLE_DRAWLINE
PRINTL 토벌할 대상을 선택하세요
CALL SINGLE_DRAWLINE
PRINTL
CALL 총력전_UI_프레임_0(3, 0, 0, 총력전_선택_캐릭터)
; CALL 보스_선택_이미지
PRINTBUTTON "[ 돌아간다 ]", -1
PRINTL
INPUT

IF RESULT == -1
	CALL 총력전_해제
	RETURN
ENDIF

DEBUGPRINTFORML selected boss id: {RESULT}
보스 = RESULT
; 총력전 창 정리
CALL 총력전_해제_기본
CLEARLINE LINECOUNT - FIRST_LINE
CALL 난이도설정(보스)
;-------------------------------------------------
;「총력전」 난이도 설정
;|  [    dr.Pepe    ]  |  [   사쿠라코    ]  |
;-------------------------------------------------
@난이도설정(보스)
#DIM FIRST_LINE
#DIM 보스


FIRST_LINE = LINECOUNT
CLEARLINE 1
$난이도루프
CALL SINGLE_DRAWLINE
PRINTL 난이도를 선택하세요
CALL SINGLE_DRAWLINE
TRYCALLFORM 총력전_보스_이름_{보스}
PRINTFORML [%ALIGN_TEXT(RESULTS,14,"CENTER")%]
PRINTL
PRINT 선택한 난이도 : 
SELECTCASE 총력전_보스_난이도
	CASE 0
		SETCOLOR 칼라_초록
		PRINTL [ HARD ]
		RESETCOLOR
	CASE 1
		SETCOLOR 칼라_시안
		PRINTL [ HARDCORE ]
		RESETCOLOR
	CASE 2
		SETCOLOR 칼라_오렌지
		PRINTL [ EXTREME ]
		RESETCOLOR
	CASE 3
		SETCOLOR 칼라_파빨강
		PRINTL [ INSANE ]
		RESETCOLOR
	CASE 4
		SETCOLOR 칼라_경고
		PRINTL [ TORMENT ]
		RESETCOLOR
ENDSELECT
PRINTL
SETCOLOR 칼라_초록
PRINTBUTTON " [ HARD      ]", 0
RESETCOLOR
PRINTL
SETCOLOR 칼라_시안
PRINTBUTTON " [ HARDCORE  ]", 1
RESETCOLOR
PRINTL
SETCOLOR 칼라_오렌지
PRINTBUTTON " [ EXTREME   ]", 2
RESETCOLOR
PRINTL
SETCOLOR 칼라_파빨강
PRINTBUTTON " [ INSANE    ]", 3
RESETCOLOR
PRINTL
SETCOLOR 칼라_경고
PRINTBUTTON " [ TORMENT   ]", 4
RESETCOLOR
PRINTL
PRINTL
CALL SINGLE_DRAWLINE
PRINTBUTTON "[완료]", 100
INPUT

IF INRANGE(RESULT, 0, 4)
	총력전_보스_난이도 = RESULT
	SELECTCASE RESULT
		CASE 0
		총력전_보스_난이도 = 0
		CASE 1
		총력전_보스_난이도 = 1
		CASE 2
		총력전_보스_난이도 = 2
		CASE 3
		총력전_보스_난이도 = 3
		CASE 4
		총력전_보스_난이도 = 4
	ENDSELECT
	
	CLEARLINE LINECOUNT - FIRST_LINE
	GOTO 난이도루프
ELSEIF RESULT == 100
	CLEARLINE LINECOUNT - FIRST_LINE
	CALL 총력전_멤버_선택(보스)
ENDIF


;-------------------------------------------------
;「총력전」 인원의 처리
;-------------------------------------------------
@총력전_멤버_선택(보스)
#DIM 보스

#DIM DYNAMIC FIRST_LINE
#DIM DYNAMIC 파티인원수
#DIM DYNAMIC 배치인원수
#DIM DYNAMIC 배치완료
#DIM DYNAMIC 배치변경 = -1 ; 위치(총력전번호) 변경중인 캐릭터 

FIRST_LINE = LINECOUNT
배치인원수 = 0
배치완료 = 0
;파티원 초기화
LOCAL:1 = 0
FOR LOCAL, 0, CHARANUM
	IF CFLAG:LOCAL:총력전선택중
		LOCAL:1 ++
	ENDIF
NEXT
파티인원수 = LOCAL:1

[IF_DEBUG]
; 총력전_ID:5 = 2
; 총력전_ID:7 = 20
; 총력전_ID:11 = 14
; 총력전_ID:12 = 113
; 총력전_ID:13 = 123
[ENDIF]

$캐릭터선택루프
CLEARLINE LINECOUNT - FIRST_LINE
FIRST_LINE = LINECOUNT
CALL 총력전_초기화_파티선택
CALL 총력전_초기화_스탯_전
CALL 총력전_처리_스탯_전
CALL 총력전_UI_프레임_0(5, 0, 1, 배치인원수 >= 2 ? 총력전_선택_캐릭터 # -1)
; CALL 총력전_파티선택_이미지
PRINTL
CALL SINGLE_DRAWLINE
IF 배치변경 == -1
	PRINTL 배치 할 캐릭터를 선택해 주세요
ELSE
	PRINTL 위치를 바꿀 캐릭터를 선택해 주세요
ENDIF
CALL SINGLE_DRAWLINE
PRINTL
LOCAL:1 = 1
FOR LOCAL, 0, CHARANUM
	IF CFLAG:LOCAL:총력전선택중
		LOCALS = %ANAME(LOCAL)%
		; 이미 배치 되 있으면/위치 변경 중 이면 비활성화
		IF MATCH(총력전_ID, LOCAL) || 배치변경 >= 0
			SETCOLOR 칼라_선택불가
			PRINTFORM [%LOCALS, 10, LEFT%]
			RESETCOLOR
		ELSE
			; 파티 자리 이동 가능하게 ~5 정도만 있으면 되지만 나중에 파티 사이즈 바뀔수 있어서
			PRINTBUTTON @"[%LOCALS, 10, LEFT%]",LOCAL + 총력전_캐릭터수
		ENDIF
		LOCAL:1 = 0
	ENDIF
NEXT
PRINTFORM %TOSTR_SPACE(30)%
PRINTBUTTON "[  리셋  ]",-1
PRINTFORM %TOSTR_SPACE(3)%
PRINTBUTTON "[  돌아간다  ]",-2
PRINTFORM %TOSTR_SPACE(3)%
PRINTL
PRINTL
PRINTL
PRINTBUTTON "[  결정  ]",-3
IF LOCAL:1
	RETURN 0
ENDIF
INPUT
DEBUGPRINTFORML 선택: {RESULT}
IF RESULT == -1
	; 리셋
	CALL 총력전_해제_기본
	배치인원수 = 0
	배치완료 = 0
	배치변경 = -1
	GOTO 캐릭터선택루프
ELSEIF RESULT == -2
	; 돌아간다
	CALL 총력전_해제
	배치인원수 = 0
	배치완료 = 0
	RETURN 1
ELSEIF RESULT == -3
	; 결정
	IF 배치완료 == 1
		PRINTW 시작
		총력전_보스 = 보스
		CALL 총력전_실행 ;(보스)
		; 리셋
		CALL 총력전_해제
		CALL SYSTEM_AUTOSAVE
	RETURN
	ELSE
		PRINTW 편성을 끝내야 합니다.
		GOTO 캐릭터선택루프
	ENDIF
ELSEIF RESULT < 총력전_캐릭터수
	; TEST CODE
	IF 배치변경 == -1
		배치변경 = RESULT
	ELSEIF 배치변경 == RESULT
		PRINTW 위치 변경 취소
		배치변경 = -1
	ELSE
		SWAP 총력전_ID:RESULT, 총력전_ID:배치변경
		; LOCAL:0 = 총력전_ID:RESULT
		; LOCAL:1 = 총력전_ID:배치변경
		; 총력전_ID:RESULT = LOCAL:1
		; 총력전_ID:배치변경 = LOCAL:0
		배치변경 = -1
	ENDIF
ELSE
	; 배치완료 != 배치인원수
	IF 배치인원수 < 파티인원수
		총력전_ID:배치인원수 = RESULT - 총력전_캐릭터수
		; 총력전_상태:배치인원수 = 총력전_상태_보통
		배치인원수++
	ENDIF
	
	IF 배치인원수 == 파티인원수
		배치완료 = 1
	ENDIF

ENDIF
GOTO 캐릭터선택루프
;행동 개시시의 공통 처리

RETURN 1


;-------------------------------------------------
;「총력전」의 선택 멤버의 리셋트
;-------------------------------------------------
@총력전_멤버_리셋
FOR LOCAL, 0, CHARANUM
	IF CFLAG:(LOCAL:0):총력전선택중
		CFLAG:(LOCAL):총력전선택중 = 0
	ENDIF
NEXT
RETURN 0